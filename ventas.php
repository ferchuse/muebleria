<?php	include "login/login_success.php";	include ("conex.php");	include ("is_selected.php");		$nombres_dias= array("LUNES", "MARTES", "MIERCOLES", "JUEVES" , "VIERNES", "SABADO", "DOMINGO");	$weekdays= array("DOMINGO", "LUNES", "MARTES", "MIERCOLES", "JUEVES" , "VIERNES", "SABADO");		function day_of_week($fecha){				$nombres_dias= array("LUNES", "MARTES", "MIERCOLES", "JUEVES" , "VIERNES", "SABADO", "DOMINGO");			}	$link = Conectarse();				if(isset($_GET["id_estatus"])){		$id_estatus = $_GET["id_estatus"];			}	else{		$id_estatus = '37';	}		if(isset($_GET["cobrador"])){		$cobrador = $_GET["cobrador"];			}	else{		$cobrador = "DIONISIO";	}	if(isset($_GET["clave_vendedor"])){		$clave_vendedor = $_GET["clave_vendedor"];			}	else{		$clave_vendedor = "TODOS";	}		if(isset($_GET["dia_semana"])){		$dia_semana  =$_GET["dia_semana"];		}else{				$dia_semana  = $weekdays[date("w")];			}?><!DOCTYPE html> <html >	<head>		<meta charset="utf-8">		<title>Ventas </title>				<?php include("styles.php");?>				<style>			@media print{			BODY{						BACKGROUND-COLOR: white !important;			}			tr{			border: 2px solid black !important;			}						}						}			tr{			border: 2px solid black !important;			}			.DOMINGO{			color: red !important;			}			.LUNES{			color: BLUE !important;						}			.MARTES{			color: BLACK !important;			color: white;			}			.MIÉRCOLES{			color: GREEN !important;			}			.JUEVES{			color: YELLOW !important;			}			.VIERNES{			color: BROWN !important;			}			.SÁBADO{			color: #e5a227 !important;			}			.MENSUAL{			color: PURPLE !important;			}			.QUINCENAL{			color: MAGENTA !important;			}			.dia_cobranza{			text-decoration: underline;			font-weight: bold;			}			table{			border: 1px solid black !important;			}		</style>	</head>	<body>		<?php			include("header.php");			$order = "tarjeta";			$field_filter = "ventas.cobrador";			$value_filter = "BRAYAN";			if(($_GET["id_estatus"]) != ''){								$q_tarjetas  = "SELECT entre_calles, 				GROUP_CONCAT(articulo) AS articulo,				estatus, ventas.referencias,				SUM(ventas.cantidad_abono) AS cantidad_abono, 				ventas.clave_vendedor, ventas.direccion, ventas.tarjeta, fecha_vencimiento, fecha_venta, nombre_cliente, sector, importe,				saldo_actual, ventas.cobrador, dia_cobranza,				MAX(fecha_hora_abono) as fecha_ultimo_abono, abono,				suma_importe,				suma_enganche,				suma_importe - suma_enganche - IF(ISNULL(total_abonado), 0, total_abonado) AS saldo_calculado												FROM ventas								LEFT JOIN (				SELECT				*				FROM				abonos				WHERE 				WEEK (fecha_hora_abono) = WEEK (CURDATE())				AND YEAR (fecha_hora_abono) = YEAR (CURDATE())				) t_abonos USING (tarjeta)								LEFT JOIN 				(				SELECT				tarjeta,				IF(ISNULL(SUM(abono)), 0 ,SUM(abono))   AS total_abonado				FROM				abonos				GROUP BY tarjeta				) as t_abonado				USING(tarjeta)								LEFT JOIN 				(				SELECT				tarjeta,				SUM(importe) AS suma_importe,				SUM(enganche) AS suma_enganche				FROM				ventas				GROUP BY tarjeta				) as t_importe				USING(tarjeta)								LEFT JOIN (				SELECT				*				FROM				incidencias				WHERE				WEEK (fecha_hora_inc) = WEEK (CURDATE())				AND YEAR (fecha_hora_inc) = YEAR (CURDATE())				) t_incidencias USING (tarjeta)																LEFT JOIN estatus USING (id_estatus)				WHERE ventas.cobrador = '$cobrador'  				AND id_estatus = ".$_GET["id_estatus"]."				AND id_estatus <> '9' 								";									if($clave_vendedor != "TODOS"){										$q_tarjetas.=	" AND ventas.clave_vendedor = '$clave_vendedor'";				}			}						else{				$q_tarjetas  = "SELECT entre_calles, 					GROUP_CONCAT(articulo) AS articulo,								estatus, ventas.referencias, 				SUM(ventas.cantidad_abono) AS cantidad_abono				, ventas.clave_vendedor, ventas.direccion, ventas.tarjeta, fecha_vencimiento, fecha_venta, nombre_cliente, sector, importe,				saldo_actual, ventas.cobrador, dia_cobranza,				MAX(fecha_hora_abono) as fecha_ultimo_abono, 				fecha_hora_abono, 				abono,				fecha_hora_inc,				suma_importe,				suma_enganche,				suma_importe - suma_enganche - IF(ISNULL(total_abonado), 0, total_abonado) AS saldo_calculado																FROM ventas 				LEFT JOIN (				SELECT				*				FROM				abonos				WHERE				WEEK (fecha_hora_abono) = WEEK (CURDATE())				AND YEAR (fecha_hora_abono) = YEAR (CURDATE())				) t_abonos USING (tarjeta)								LEFT JOIN (				SELECT				*				FROM				incidencias				WHERE				WEEK (fecha_hora_inc) = WEEK (CURDATE())				AND YEAR (fecha_hora_inc) = YEAR (CURDATE())				) t_incidencias USING (tarjeta)								LEFT JOIN 				(				SELECT				tarjeta,				IF(ISNULL(SUM(abono)), 0 ,SUM(abono))   AS total_abonado				FROM				abonos				GROUP BY tarjeta				) as t_abonado				USING(tarjeta)								LEFT JOIN 				(				SELECT				tarjeta,				SUM(importe) AS suma_importe,				SUM(enganche) AS suma_enganche				FROM				ventas				GROUP BY tarjeta				) as t_importe				USING(tarjeta)																LEFT JOIN estatus USING (id_estatus)				WHERE 				ventas.cobrador = '$cobrador' 								AND id_estatus <> '9'  												";								if($clave_vendedor != "TODOS"){										$q_tarjetas.=	" AND ventas.clave_vendedor = '$clave_vendedor'";				}							}							if($dia_semana != ''){								$q_tarjetas.= " AND dia_cobranza = '$dia_semana' ";							}			if($_GET["sector"] != ''){								$q_tarjetas.= " AND sector = '{$_GET["sector"]}' ";							}						$q_tarjetas.= "	GROUP BY tarjeta 				ORDER BY tarjeta DESC ";						$result_tarjetas=mysql_query($q_tarjetas,$link) or die("Error en: $q_tarjetas  ".mysql_error());						while($fila = mysql_fetch_assoc($result_tarjetas)){								$filas[] = $fila;			}			//echo "<pre>".$q_tarjetas."</pre>";		?>		<div class="container-fluid">						<?php //echo $dia_semana;?>			<div class="row ">				<div class="col-sm-12">					<h3 class="etiqueta">Reporte de Ventas </h3>				</div>			</div>						<form action="" class="" method="get" >				<div class="row">					<div class=" col-xs-2">						<label for="cobrador" class="etiqueta">							Cobrador						</label>						<select class="form-control" id="cobrador" name="cobrador" >							<option value="">Sin Cobrador	</option>							<?php 								$q_cobradores = "SELECT * FROM cobradores WHERE activo=1 ORDER BY nombre_cobrador";								$result_cobradores=mysql_query($q_cobradores,$link) or die("Error en: $q_cobradores  ".mysql_error());																while($row = mysql_fetch_assoc($result_cobradores)){									$cobrador_db = $row["nombre_cobrador"];																	?>								<option value="<?php echo $cobrador_db;?>" 								<?php echo is_selected($cobrador_db, $cobrador);?> > 									<?php echo $cobrador_db;?> 									</option>								<?php								}							?>						</select>					</div>					<div class=" col-xs-2">						<label for="cobrador" class="etiqueta">							Vendedor						</label>						<select class="form-control" id="clave_vendedor" name="clave_vendedor" >							<option value="TODOS">TODOS</option>							<?php 								$q_vendedores = "SELECT * FROM vendedores  ORDER BY clave_vendedor";								$result_vendedores=mysql_query($q_vendedores,$link) or die("Error en: $q_vendedores  ".mysql_error());																while($row = mysql_fetch_assoc($result_vendedores)){									$vendedor_db = $row["clave_vendedor"];																	?>								<option value="<?php echo $vendedor_db;?>" 								<?php echo is_selected($vendedor_db, $clave_vendedor);?> > 									<?php echo $vendedor_db;?> 									</option>								<?php								}							?>						</select>					</div>					<div class="col-xs-3">						<label for="id_estatus" class="etiqueta">							Estatus						</label>						<select class="form-control" name="id_estatus" id="id_estatus" >							<option value="">TODAS	</option>							<?php 								$q_estatus = "SELECT * FROM estatus order by estatus";								$result_estatus=mysql_query($q_estatus,$link) or die("Error en: $q_estatus  ".mysql_error());																while($row = mysql_fetch_assoc($result_estatus)){									$id_estatus_db = $row["id_estatus"];									$estatus_db = $row["estatus"];																	?>								<option value="<?php echo $id_estatus_db;?>"  <?php echo is_selected($id_estatus_db, $id_estatus);?>  > 																		<?php echo $estatus_db;?> 									</option>								<?php								}							?>						</select>					</div>					<div class="col-xs-3 col-sm-2">						<label for="sector" class="etiqueta">							Sector						</label>						<select class="form-control" name="sector" id="sector" >							<option value="">TODOS	</option>							<?php 								$q_estatus = "SELECT * FROM sectores ORDER BY sector ";								$result_estatus=mysql_query($q_estatus,$link) or die("Error en: $q_estatus  ".mysql_error());																while($row = mysql_fetch_assoc($result_estatus)){									$id_estatus_db = $row["sector"];									$estatus_db = $row["sector"];																	?>								<option value="<?php echo $id_estatus_db;?>"  <?php echo is_selected($id_estatus_db, $id_estatus);?>  > 																		<?php echo $estatus_db;?> 									</option>								<?php								}							?>						</select>					</div>					<div class="form-group col-xs-2">						<label for="dia_semana" class="etiqueta">							DIA						</label>						<select class="form-control" name="dia_semana" id="dia_semana" >							<option value="">TODOS	</option>							<?php foreach($nombres_dias as $index_semana=>$dia_semana_db){							?>							<option value="<?php echo $dia_semana_db;?>"  <?php echo is_selected($dia_semana_db, $dia_semana);?>  > 								<?php echo $dia_semana_db;?> 								</option>							<?php							}							?>							<option value="QUINCENAL"  <?php echo is_selected('QUINCENAL', $dia_semana);?>  > 								QUINCENAL							</option>							<option value="MENSUAL"  <?php echo is_selected('MENSUAL', $dia_semana);?>  > 								MENSUAL							</option>						</select>					</div>					<div class="form-group"  style="margin-top: 20px;">						<button type="submit" class="btn btn-md btn-success hidden-print pull-right"  >							<i class="fa fa-search"></i> Buscar  						</button>					</div>				</div>			</form>									<hr class="hidden-print"> 						<div class='row'>				<div class='col-xs-8'>					<h4 class="etiqueta">						<?php echo mysql_num_rows($result_tarjetas);?> Tarjetas						<span class="visible-print"> Fecha: <?php echo date("d/m/Y");?></span>					</h4>				</div>				<div class='col-xs-3 pull-right hidden-print'>					<button class="btn btn-info" onclick="window.print();">						<i class="fa fa-print"></i> Imprimir 					</button>					<button type="button" class="btn btn-success botonExcel"  >						<i class="fa fa-file-excel-o"></i> Exportar  					</button>				</div> 			</div>							<?php if(isset($cobrador)){	?>				<pre hidden>					<?php echo $q_tarjetas;?>				</pre>								<div id="div_tabla_ventas" class="lbl_blanca" >					<table id="tabla_reporte" class="table-bordered" border="1">						<thead>							<tr>									<th>Fecha Venta</th>								<th>Tarjeta</th>								<th>Nombre Cliente</th>								<th>Dirección</th>								<th>Sector</th>								<th>Importe Total</th>								<th class="no_imprimir">Saldo Actual</th>								<th>Vendedor</th> 								<th>Artículo</th>								<th>Dia de Cobro</th>								<th>Abono Sem</th>								<th class="no_imprimir">Fecha Ultimo Abono</th>								<th class="hidden">Dias de Atraso</th>								<th class="no_imprimir">Estatus</th>								<th class="no_imprimir">Cobrado</th>								<th class="no_imprimir">Incidencia</th>							</tr>									</thead>									<tbody>										<?php																foreach($filas AS $index=> $row){																											$tarjeta = $row["tarjeta"];									$fecha_venta = date("d/m/Y", strtotime($row["fecha_venta"]));									//$fecha_vencimiento = date("d/m/Y", strtotime($row["fecha_vencimiento"]));									if ($row["fecha_vencimiento"] != ''){																				$fecha_vencimiento = date("d/m/Y", strtotime($row["fecha_vencimiento"]));																				}else{										$fecha_vencimiento = '-';																			}									$date1= date_create();									$date2= date_create($row["fecha_vencimiento"]); 									$diff=date_diff($date1,$date2);																		$dias_retraso = $diff->format("%a");									if ($row["fecha_ultimo_abono"] != ''){																				$fecha_ultimo_abono = date("d/m/Y", strtotime($row["fecha_ultimo_abono"]));																				}else{										$fecha_ultimo_abono = '-';																			}									$nombre_cliente =  $row["nombre_cliente"]; 									$direccion =  $row["direccion"]; 									$articulo =  $row["articulo"]; 									$entre_calles =  $row["entre_calles"]; 									$dia_cobranza =  $row["dia_cobranza"]; 									$cobrador =  $row["cobrador"]; 									$clave_vendedor =  $row["clave_vendedor"]; 									$sector = $row["sector"]; 									$importe = $row["importe"]; 									$referencias = $row["referencias"]; 									$enganche = $row["enganche"]; 									$sum_enganches[] = $enganche; 									$saldo_actual = $row["saldo_actual"]; 									$estatus = $row["estatus"]; 									$cantidad_abono = $row["cantidad_abono"]; 																		$suma_saldo_actual+=	$saldo_actual;									$suma_abonos+=	$cantidad_abono;									//$fecha_ultimo_abono = $row["fecha_ultimo_abono"]; 																	?> 								<tr class="<?php echo $row["estatus"]== 'Devolución de Mercancia' ? 'rojo' : ''?>">									<td class="">										<?php echo "$fecha_venta";?>									</td>																		<td>																				<a class="h4" target="_blank" href="buscar_tarjeta.php?tarjeta=<?php echo "$tarjeta";?>" >											<b><?php echo "$tarjeta";?> </b>										</a>									</td>									<td>										<?php echo "$nombre_cliente";?>									</td>									<td>										<?php echo "<b>Domicilio:</b> $direccion</br></br>";?>										<?php echo $referencias != '' ? "<b>Referencias:</b>  $referencias<br> ": "";?>										<?php echo  $entre_calles != '' ? "<b>Entre Calles: </b> $entre_calles<br><br>": "";?>									</td> 									<td>										<?php echo "$sector";?>									</td>									<td class="no_imprimir">										<?php echo  number_format($row["suma_importe"]);?>									</td>																		<td>										<?php echo  number_format($row["saldo_calculado"]);?>									</td>									<td><?php echo "$clave_vendedor";?></td>									<td class=""><?php echo $articulo;?></td>									<td CLASS="dia_cobranza <?PHP ECHO $dia_cobranza;?>">										<?php echo "$dia_cobranza";?>									</td>									<td>										<?php echo number_format("$cantidad_abono",0);?>									</td>									<td>										<?php 											$fecha_ultimo_abono  =  date("d/m/Y", strtotime($row["fecha_ultimo_abono"]));											echo $fecha_ultimo_abono  == '31/12/1969' ? "" : $fecha_ultimo_abono;										?>									</td>																			<td class="hidden">										<?php echo "$dias_retraso";?>									</td>									<td class="no_imprimir">										<?php echo "$estatus";?>									</td>																		<td class="no_imprimir">										<?php											$fecha_abono = strtotime($row["fecha_hora_abono"]);										echo ($fecha_abono === false) ? '' : date('d-m-Y', $fecha_abono);?>									</td>									<td class="no_imprimir">										<?php											$fecha_inc = strtotime($row["fecha_hora_inc"]);										echo ($fecha_inc === false) ? '' : date('d-m-Y', $fecha_inc);?>									</td>								</tr>								<?php																	}							?>							</tbody>							<tfoot class="h4">								<tr>								<td colspan="6"></td>								<td ><b>$ <?php echo number_format($suma_saldo_actual)?></b></td>								<td ></td>								<td ></td>								<td ></td>								<td><b>$ <?php echo number_format($suma_abonos)?></b></td>								<td ></td>								<td ></td>								<td ></td>								<td ></td>							</tr>						</tfoot>												</table>															</div>				<?php									}			?>									</div>		<?php include("scripts.php");?>		<script>			$( document ).ready(function() {				$(".botonExcel").click(function(){										$('#tabla_reporte').tableExport(					{						type:'excel',						tableName:'Registros',						escape:'false'					});				});			}); 		</script>	</body></html>			