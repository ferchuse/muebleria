<?php		include ("conex.php");	$link = Conectarse();		$nombre_usuario = $_SESSION["nombre_usuario"];		if($_POST["guardar"]){		$ruta = $_POST["ruta"];		$kilometraje_inicial = $_POST["kilometraje_inicial"];		$codigos = $_POST["codigos"];		$productos = $_POST["productos"];		$cantidades = $_POST["cantidades"];							$insert_carga="INSERT INTO carga_mercancia			SET ruta = $ruta , fecha_carga = CURDATE(),			hora_carga = CURTIME() , entrega = '$nombre_usuario',			kilometraje_inicial = '$kilometraje_inicial' ";			mysql_query($insert_carga) or die('Error insertando factura: '.mysql_error());						$id_carga = mysql_insert_id();						//Inserta una salida de almacen			$insert_salida ="INSERT INTO salidas_almacen					SET  fecha = CURDATE(), hora = CURTIME() , tipo_salida = 'Carga de Camioneta', entrega = '$nombre_usuario'";								mysql_query($insert_salida) or die('Error insertando detalle: '.mysql_error());						$id_salida = mysql_insert_id();											foreach($cantidades as $key => $value){				if($value){										$insert_detalle_carga ="INSERT INTO detalle_carga					SET id_carga = '$id_carga' , id_producto = '$codigos[$key]', cantidad = '$value'";										mysql_query($insert_detalle_carga) or die('Error insertando detalle: '.mysql_error());										$update_existencias_almacen ="UPDATE existencias_almacen 					SET existencia_en_piezas = (SELECT  existencia_en_piezas FROM(														SELECT * FROM existencias_almacen) AS existencia_actual														WHERE codigo_barras = '$codigos[$key]') - '$value' 											WHERE codigo_barras = '$codigos[$key]'";					mysql_query($update_existencias_almacen) 					or die("Error actualizando existencia: $update_existencias_almacen ".mysql_error());												//Actualiza las existencia de cada ruta 					$update_existencias_ruta ="UPDATE existencias_ruta					SET piezas = '$value' + (SELECT  piezas FROM(														SELECT * FROM existencias_ruta) AS existencia_actual														WHERE codigo_barras = '$codigos[$key]' AND ruta = '$ruta')											WHERE codigo_barras = '$codigos[$key]' AND ruta = '$ruta'";																mysql_query($update_existencias_ruta) 					or die("Error actualizando existencia: $update_existencias_ruta ".mysql_error());								//Tabla de salidas 															$insert_detalle_salida ="INSERT INTO detalle_salida_almacen					SET id_salida = '$id_salida' , codigo_barras = '$codigos[$key]', piezas = '$value'";										mysql_query($insert_detalle_salida)					or die("Error insertando detalle salida $insert_detalle_salida  : ".mysql_error());				}			}						echo "Carga Realizada Correctamente";			}?>