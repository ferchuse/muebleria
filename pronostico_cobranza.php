<?php	include "login/login_success.php";	include "is_selected.php";	include ("conex.php");	//vinclude ("is_selected.php");	$link = Conectarse();	$dias = array("Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado");	//setlocale(LC_TIME, "es_ES");	//$dia_inicial = $dia_semana["wday"] -1;	//$dia_final = 6 - $dia_semana["wday"] ;		if($_GET["fecha_inicial"]){			$sector = $_GET["sector"];		$fecha_inicial = $_GET["fecha_inicial"];		$fecha_final = $_GET["fecha_final"];				$cobrador = $_GET["cobrador"];		$nombre_dia = $_GET["nombre_dia"];		$estatus = $_GET["estatus"];			}	else{		$dia_semana = date("w");				$dia_inicial = 5-$dia_semana;		$dia_final = 3 - $dia_semana ;				$fecha_inicial = date("d/m/Y",strtotime("-$dia_inicial days"));		$fecha_final = date("d/m/Y",strtotime("+$dia_final days"));		}	$col_lunes = array();	$col_martes = array();	$col_miercoles = array();	$col_jueves = array();	$col_viernes = array();	$col_sabado = array();	$col_domingo = array();	?><html xmlns="http://www.w3.org/1999/xhtml"><head>	<title>Pronostico de Cobranza </title>	<meta charset="utf-8" />		<link rel="stylesheet" type="text/css" href="css/layout.css" />	<link rel="stylesheet" type="text/css" href="css/layout.css"  media="print"/>			<link rel="stylesheet" type="text/css" href="css/redmond/jquery-ui-1.10.3.custom.css"  />	<link rel="stylesheet" type="text/css" href="tablecloth/tablecloth.css" media="screen" />	 	 	<script type="text/javascript" src="tablecloth/tablecloth.js"></script>	<script type="text/javascript" charset="utf8" src="DataTables-1.10.4/media/js/jquery.js"></script>	<script type="text/javascript" src="js/jquery-ui-1.10.3.custom.js"></script>	<script type="text/javascript" src="js/validar.js"></script>	<script type="text/javascript" src="js/jquery.ui.datepicker-es.js"></script>		<script>			$( document ).ready(function() {					$(".botonExcel").click(function(event) {				$("#datos_a_enviar").val( $("<div>").append( $("#Exportar_a_Excel").eq(0).clone()).html());				$("#FormularioExportacion").submit();		});				$( "#fecha_inicial" ).datepicker({			changeMonth: true,			changeYear: true,			//yearRange: '1920:2000'		});		$( "#fecha_final" ).datepicker({			changeMonth: true,			changeYear: true,			//yearRange: '1920:2000'		});						function validar(){		txt_f_i= $("#fecha_inicial").val();		txt_f_f= $("#fecha_final").val();					if (txt_f_i == ''){				alert("Ingresa una Fecha Inicial") ;				return false;			}			if (txt_f_f == ''){				alert("Ingresa una Fecha Final") ;				return false;			}						//return true	;					}		$( ".borrar").click(function(event) {			if (confirm('¿Esta seguro que desea eliminar?')){				boton= $(this);				$.get('borrar.php', {					borrar: "producto", 						id: boton.attr("id"),					}, function(data){						//alert(data);					boton.closest("tr").fadeOut();				});			}			else{				return false;			}			return false; 		 });		 	});	</script></head><body><?phpinclude("header.php");?><div class="contenido">	<div class="encabezado_imprimir">		Muebleria Casa Roberto	</div>	<div class='titulo no_imprimir'>Pronostico de Cobranza </div>	<div class="no_imprimir" id="div_form">	<form name="form_rep_mes" method="get" enctype="multipart/form-data" action="" onsubmit="return validar(this.name);"	>				<span class="etiqueta">					Fecha Inicial: <input size="10" type="text" name="fecha_inicial" id="fecha_inicial" value="<?php echo $fecha_inicial;?>" />				</span>				<span class="etiqueta">					Fecha Final: <input size="10" type="text" name="fecha_final" id="fecha_final" value="<?php echo $fecha_final;?>" />				</span>								<span class="etiqueta">					Cobrador				</span>					<select name="cobrador">						<option value="">ELIGE UN COBRADOR</option>						<?php 						$q_cobradores = "SELECT * FROM cobradores ORDER BY nombre_cobrador";						$result_cobradores=mysql_query($q_cobradores,$link) or die("Error en: $q_cobradores  ".mysql_error());												while($row = mysql_fetch_assoc($result_cobradores)){							$cobrador_db = $row["nombre_cobrador"];													?>						<option value="<?php echo $cobrador_db;?>" 							<?php echo is_selected($cobrador_db, $cobrador);?> > 							<?php echo $cobrador_db;?> 							</option>						<?php						}						?>					</select>				<span class="etiqueta">					Día				</span>				<select name="nombre_dia" id="nombre_dia">					<option value="LUNES"> LUNES	</option>					<option value="MARTES"> MARTES	</option>					<option value="MIÉRCOLES"> MIÉRCOLES	</option>					<option value="JUEVES"> JUEVES	</option>					<option value="VIERNES"> VIERNES	</option>					<option value="SÁBADO"> SÁBADO	</option>					<option value="DOMINGO"> DOMINGO 	</option>				</select>				<span class="etiqueta">					Estatus				</span>					<select name="estatus"  id="estatus">							<option value="" <?php echo is_selected("", $estatus)?>>								Elige un Estatus								</option>							<option value="Al Corriente" <?php echo is_selected("Al Corriente", $estatus)?>>								Al Corriente								</option>							<option value="Atraso" <?php echo is_selected("Atraso", $estatus)?>>								Atraso							</option>							<option value="En Proceso" <?php echo is_selected("Negativa de Pago", $estatus)?>>								Negativa de Pago								</option>							<option value="Ilocalizada" <?php echo is_selected("Ilocalizada", $estatus)?>>								Ilocalizada								</option>							<option value="Ilocalizada Año Actual" <?php echo is_selected("Ilocalizada Año Actual", $estatus)?>>								Ilocalizada Año Actual								</option>							<option value="Ilocalizada Años Anteriores" <?php echo is_selected("Ilocalizada Años Anteriores", $estatus)?>>								Ilocalizada Años Anteriores								</option>							<option value="Tarjeta Nueva" <?php echo is_selected("Tarjeta Nueva", $estatus)?>>								Tarjeta Nueva							</option>							<option value="Salvedades" <?php echo is_selected("Salvedades", $estatus)?>>								Salvedades							</option>							<option value="Liquidada" <?php echo is_selected("Liquidada", $estatus)?>>								Liquidada							</option>							<option value="Devolución de Mercancia" <?php echo is_selected("Devolución de Mercancia", $estatus)?>>								Devolución de Mercancia							</option>							<option value="Notificada al Supervisor" <?php echo is_selected("Notificada al Supervisor", $estatus)?>>								Notificada al Supervisor								</option>						</select>				<input class="boton" type="submit" name="buscar_fecha" value="Buscar" />	</form>	</div>	<?php 	if(isset($_GET["buscar_fecha"])){		$cobrador = $_GET["cobrador"];		$nombre_dia = $_GET["nombre_dia"];		$estatus = $_GET["estatus"];				$fecha_inicial = $_GET["fecha_inicial"];		$fecha_final = $_GET["fecha_final"];				$dia_fecha_inicial = date_create_from_format("d/m/Y", $fecha_inicial);		$dia_fecha_inicial = $dia_fecha_inicial->getTimestamp();		$dia_fecha_inicial = date("w", $dia_fecha_inicial);		$dia_fecha_inicial = $dias[$dia_fecha_inicial];				$dia_fecha_final = date_create_from_format("d/m/Y", $fecha_final);		$dia_fecha_final = $dia_fecha_final->getTimestamp();		$dia_fecha_final = date("w", $dia_fecha_final);		$dia_fecha_final = $dias[$dia_fecha_final];				$arr_nombres_dias = array("LUNES","MARTES","MIÉRCOLES","JUEVES","VIERNES","SÁBADO", "DOMINGO");						$q_tarjetas = "SELECT							ventas.tarjeta,							nombre_cliente,							saldo_actual,							cantidad_abono						FROM							ventas						WHERE							ventas.cobrador = '$cobrador'						AND dia_cobranza = '$nombre_dia'						AND saldo_actual > 0						AND estatus = '$estatus'						ORDER BY tarjeta";			$result_tarjetas=mysql_query($q_tarjetas,$link) or die("Error en: $q_tarjetas  ".mysql_error());						$index_dia =  array_search($nombre_dia, $arr_nombres_dias);						$q_cobrado = "SELECT							sum(abono) AS total_cobrado, ventas.tarjeta						FROM							abonos						INNER JOIN ventas						ON ventas.tarjeta = abonos.tarjeta						WHERE							ventas.cobrador = '$cobrador'						AND WEEKDAY(fecha_hora_abono) = '$index_dia'						AND saldo_actual > 0						AND estatus = '$estatus'						AND DATE(fecha_hora_abono) BETWEEN STR_TO_DATE('$fecha_inicial', '%d/%m/%Y')						AND STR_TO_DATE('$fecha_final', '%d/%m/%Y')							ORDER BY tarjeta";									$result_cobrado = mysql_query($q_cobrado,$link) or die("Error en 253: $q_cobrado  ".mysql_error());			$row_cobrado = mysql_fetch_assoc($result_cobrado);			$total_cobrado = $row_cobrado["total_cobrado"];						$q_pronosticado = "SELECT							sum(cantidad_abono) AS total_pronosticado, tarjeta						FROM							ventas						WHERE							ventas.cobrador = '$cobrador'						AND dia_cobranza = '$nombre_dia'						AND saldo_actual > 0						AND estatus = '$estatus'";			$result_pronosticado = mysql_query($q_pronosticado,$link) or die("Error en: $q_pronosticado  ".mysql_error());			$row_pronosticado = mysql_fetch_assoc($result_pronosticado);			$total_pronosticado = $row_pronosticado["total_pronosticado"];						$q_incidencias = "SELECT							count(tarjeta) AS total_incidencias						FROM							incidencias						WHERE							incidencias.cobrador = '$cobrador'						AND WEEKDAY(fecha_hora_inc) = $index_dia						AND DATE(fecha_hora_inc) BETWEEN STR_TO_DATE('$fecha_inicial', '%d/%m/%Y')						AND STR_TO_DATE('$fecha_final', '%d/%m/%Y')							";			$result_incidencias = mysql_query($q_incidencias,$link) or die("Error en: $q_incidencias  ".mysql_error());			$row_incidencias = mysql_fetch_assoc($result_incidencias);			$total_incidencias = $row_incidencias["total_incidencias"];						$q_cobros = "SELECT							count(tarjeta) AS total_cobros						FROM							abonos						WHERE							abonos.cobrador = '$cobrador'						AND WEEKDAY(fecha_hora_abono) = $index_dia						AND DATE(fecha_hora_abono) BETWEEN STR_TO_DATE('$fecha_inicial', '%d/%m/%Y')						AND STR_TO_DATE('$fecha_final', '%d/%m/%Y')							";			$result_cobros = mysql_query($q_cobros,$link) or die("Error en: $q_cobros  ".mysql_error());			$row_cobros = mysql_fetch_assoc($result_cobros);			$total_cobros = $row_cobros["total_cobros"];						$tarjetas_por_dia = mysql_num_rows($result_tarjetas);								//print_r (date_create_from_format("d/m/Y",$fecha_final));		?>		<div class='titulo'>Pronostico de Cobranza del : <?php echo $dia_fecha_inicial ," ",  $fecha_inicial ," al ",  $dia_fecha_final ," ", $fecha_final; ?> </div>		<div class='etiqueta'>Cobrador :  <?php echo $cobrador ;?> </div>		<div class='etiqueta'>Estatus :  <?php echo $estatus ;?> </div>		<div class="etiqueta">Día: <?php echo $nombre_dia;?></div>		<div class="etiqueta">Total de Tarjetas: <?php echo $tarjetas_por_dia;?></div>		<div class="etiqueta">Num de Incidencias: <?php echo $total_incidencias; ?></div>		<div class="etiqueta">Num de Cobros: <?php echo $total_cobros; ?></div>		<div class="etiqueta">Num de Visitas: <?php echo $total_cobros + $total_incidencias; ?></div>					<div class="etiqueta">Total Pronosticado: $<?php echo number_format($total_pronosticado,2);?></div>		<div class="etiqueta">Total Cobrado: $<?php echo number_format($total_cobrado,2); ?></div>				<div id="cid_4" class="lbl_blanca no_imprimir">			<form action="ficheroExcel.php"  accept-charset="ISO-8859-1" method="post" target="_blank" id="FormularioExportacion">				<p>Exportar a Excel  <img src="img/export_to_excel.gif" class="botonExcel" /></p>				<input type="hidden" id="datos_a_enviar" name="datos_a_enviar" />			</form>		</div>				<div class="btn_imprimir no_imprimir">			<button class="boton" onclick="javascript:window.print();">				Imprimir			</button>		</div>						<table border="1" id="Exportar_a_Excel">							<th>TARJETA</th>				<th>NOMBRE</th>								<th>SALDO ACTUAL</th>				<th>ABONO SEMANAL</th>				<th>LUNES</th>				<th>MARTES</th>				<th>MIERCOLES</th>				<th>JUEVES</th>				<th>VIERNES</th>				<th>SABADO</th>				<th>DOMINGO</th>												<?php								$sum_abonos = array();				$total_visitas = array();				$total_abonos = array();				$total_incidencias = array();				$total_incidencias = array();				$contador = 0;								while($row = mysql_fetch_assoc($result_tarjetas)){					$tarjeta = $row["tarjeta"];					$nombre_cliente = $row["nombre_cliente"];					$cantidad_abono = $row["cantidad_abono"];					$saldo_actual = $row["saldo_actual"];					$arr_abonos_dia = array();					switch($nombre_dia){						case 'LUNES': $pronos_lunes[] = $cantidad_abono;						break;						case 'MARTES': $pronos_martes[] = $cantidad_abono;						break;						case 'MIERCOLES': $pronos_miercoles[] = $cantidad_abono;						break;						case 'JUEVES': $pronos_jueves[] = $cantidad_abono;						break;						case 'VIERNES': $pronos_viernes[] = $cantidad_abono;						break;						case 'SABADO': $pronos_sabado[] = $cantidad_abono;						break;						case 'DOMINGO': $pronos_domingo[] = $cantidad_abono;						break;					}										for($i=0; $i < 7 ; $i++){											$q_abonos ="						SELECT * FROM 						(SELECT  tarjeta, (abono) as abono_dia FROM abonos 						WHERE DATE(fecha_hora_abono)						BETWEEN str_to_date('$fecha_inicial','%d/%m/%Y') 						AND str_to_date('$fecha_final','%d/%m/%Y')						AND cobrador = '$cobrador' AND WEEKDAY(DATE(fecha_hora_abono)) = $i						AND tarjeta = '$tarjeta')  AS abono_dia												";						$result_abonos= mysql_query($q_abonos) or die("Error en: $q_abonos ".mysql_error());												$num_rows = mysql_num_rows($result_abonos);												if($num_rows > 0){							$row2 = mysql_fetch_assoc($result_abonos);														$abono_dia = $row2["abono_dia"];														switch($i){								case 0:									$col_lunes[] = $abono_dia;								break;								case 1:									$col_martes[] = $abono_dia;								break;								case 2:									$col_miercoles[] = $abono_dia;								break;								case 3:									$col_jueves[] = $abono_dia;								break;								case 4:									$col_viernes[] = $abono_dia;								break;								case 5:									$col_sabado[] = $abono_dia;								break;								case 6:									$col_domingo[] = $abono_dia;								break;														}																				}						else{							$q_incidencia = "								SELECT									tarjeta,									tipo_inc								FROM									incidencias								WHERE									DATE(fecha_hora_inc) BETWEEN str_to_date(										'$fecha_inicial',										'%d/%m/%Y'									)								AND str_to_date('$fecha_final', '%d/%m/%Y')								AND cobrador = '$cobrador'								AND WEEKDAY(DATE(fecha_hora_inc)) = $i								AND tarjeta = '$tarjeta'";							$result_inc= mysql_query($q_incidencia) or die("Error en: $q_incidencia ".mysql_error());													$num_rows = mysql_num_rows($result_inc);														if($num_rows > 0){								$row2 = mysql_fetch_assoc($result_inc);																$abono_dia = $row2["tipo_inc"];							}							else{								$abono_dia = "";							}						}						$arr_abonos_dia[] = $abono_dia;											}										?>					<tr>						<td> <a target="_blank" href="buscar_tarjeta.php?tarjeta=<?php echo $tarjeta ; ?>"><?php echo $tarjeta ; ?></a>	</td>						<td> <?php echo $nombre_cliente ; ?>	</td>						<td class="number_format"> <?php echo number_format($saldo_actual, 2) ; ?>	</td>						<td class="number_format"> <?php echo $cantidad_abono ; ?>	</td>						<td class="number_format"> <?php echo $arr_abonos_dia[0]  ; ?>	</td>						<td class="number_format"> <?php echo $arr_abonos_dia[1] ; ?>	</td>						<td class="number_format"> <?php echo $arr_abonos_dia[2]  ; ?>	</td>						<td class="number_format"> <?php echo $arr_abonos_dia[3]  ; ?>	</td>						<td class="number_format"> <?php echo $arr_abonos_dia[4]  ; ?>	</td>						<td class="number_format"> <?php echo $arr_abonos_dia[5]  ; ?>	</td>						<td class="number_format"> <?php echo $arr_abonos_dia[6]  ; ?>	</td>											</tr>					<tr>											</tr>				<?php										} 				?>			</table> 						<br>			<br>			<br>			<br>							<?php	}	?>		</div><div id="debug" class="no_imprimir">	<?php	//echo $q_cobrado;		//echo "Index of $nombre_dia:", $index_dia;		?></div></body></html>