<?php	header("Content-Type: application/json");	include ("conex.php");	$link = Conectarse();	$tarjeta= $_GET["tarjeta"];		$respuesta = array();		$query ="SELECT 	*, 	importe - enganche - IF(ISNULL(total_abonado),0, total_abonado) AS saldo_calculado	FROM ventas	LEFT JOIN 	(	SELECT	tarjeta,	SUM(abono) AS total_abonado	FROM	abonos	WHERE	tarjeta = '$tarjeta'	) as t_abonado	USING(tarjeta)		WHERE tarjeta = '$tarjeta'";			$result=mysql_query($query,$link) or die("Error en: $query  ".mysql_error());	$respuesta["existe"] = mysql_num_rows($result);	while($row = mysql_fetch_assoc($result)){				$tarjeta = $row["tarjeta"];		$q_ultimos_abonos = "SELECT abono, 		DATE_FORMAT(fecha_hora_abono,'%d/%m/%y')  AS fecha_abono		FROM		abonos		WHERE		tarjeta = '$tarjeta'		ORDER BY		fecha_hora_abono DESC 		LIMIT 3";		$result_abonos = mysql_query($q_ultimos_abonos,$link) or die("Error en: $q_ultimos_abonos  ".mysql_error());		$abonos= array();		while($fila_abonos = mysql_fetch_assoc($result_abonos)){			$abonos[] = $fila_abonos;					}		$row["ultimos_abonos"] = $abonos;		$dt_fecha_hoy = date_create();		$dt_fecha_vencimiento = date_create($row["fecha_vencimiento"]);		$interval = date_diff($dt_fecha_hoy, $dt_fecha_vencimiento);		$dias_atraso =	$interval->format("%r%a");				$row["dias_atraso"] =  $dias_atraso;		if($dias_atraso < 0 ){									$semanas_atraso =  	abs(floor($dias_atraso / 7));			$row["intereses"] = 	$semanas_atraso  * .1 * 	$row["cantidad_abono"];			$row["semanas_atraso"] =  	$semanas_atraso;		}		else{						$row["semanas_atraso"] =  	0;		}		$row["fecha_vencimiento"] = date("d/m/Y", strtotime($row["fecha_vencimiento"])) ;		$row["fecha_venta"] = date("d/m/Y", strtotime($row["fecha_venta"])) ;		$row["fecha_ultimo_abono"] = date("d/m/Y", strtotime($row["fecha_ultimo_abono"])) ;		$respuesta["datos"] = $row;	}		echo json_encode( $respuesta );	?>