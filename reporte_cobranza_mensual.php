<?php	include "login/login_success.php";	include ("conex.php");	include ("is_selected.php");	$link = Conectarse();	$dias = array("Domingo","Lunes","Martes","Miércoles","Jueves","Viernes","Sábado");	$meses = array("ENE","FEB","MAR","ABR","MAY","JUN","JUL", "AGO", "SEP", "OCT", "NOV", "DIC");		if(isset($_GET["year"])){		$year = $_GET["year"];	}	else{		$year = date("Y");	}?><!DOCTYPE html><html>	<head>		<title>Reporte de Cobranza Mensual</title>		<meta charset="utf-8" />				<?php include("styles.php");?>			</head>	<body>		<?php			include("header.php");		?>		<div class="contenido container">			<div class="encabezado_imprimir">				Muebleria Casa Roberto			</div>			<div class='titulo no_imprimir'>Reporte De Cobranza Mensual </div>			<div class="no_imprimir row" id="div_form">				<div class="col-sm-12">					<form name="form_rep_mes"  class="form-inline" method="get" action="" >						<span class="form-group">							<label for="fecha_inicial" class="etiqueta">Año: </label>							<select class="form-control" name="year" id="fecha_inicial">								<?php 									for($año = 2017; $año < 2040; $año++ ){?>									<option 	<?php echo is_selected($year, $año);?>   value="<?php echo $año?>"><?php echo $año;?></option>									<?php									}								?>							</select>						</span>						<button type="submit" class="btn btn-success">							<i class="fa fa-search"></i> Buscar						</button>					</form>				</div>			</div>			<?php 																if(isset($_GET["year"])){					$q_ventas = "SELECT					MONTH(fecha_hora_abono) AS mes,					SUM(abono) AS importe_mensual					FROM					abonos					WHERE 					YEAR(fecha_hora_abono) = '$year'					AND tipo_abono ='Abono'					GROUP BY					MONTH(fecha_hora_abono)					";										$result_ventas=mysql_query($q_ventas,$link) or die("Error en: $q_ventas  ".mysql_error());									?>				<section id="section_acumulado">					<h4 class="visible-print">						<div class="row">							<div class="col-sm-6">								Reporte de Cobranza Año: <?php echo $year;  ?>  							</div>						</div>					</h4>										<div class="btn_imprimir no_imprimir">						<button type="button" class="btn btn-primary" onclick="javascript:window.print();">							<i class="fa fa-print"> </i> Imprimir						</button>						<button type="button" class="btn btn-success btn_exportar" >							<i class="fa fa-arrow-right"> </i> Exportar						</button>					</div>					<div class="row">						<div class="col-sm-6">							<table border="1" id="tabla_grafica" class="tabla3 tabla_grafica">								<thead>									<th>Mes</th>									<th>Acumulado</th>								</thead>								<tbody>									<?php										$suma_importes = array();																				while($row = mysql_fetch_assoc($result_ventas)){											$importe_total = $row["importe_mensual"];												$suma_importes[] = $row["importe_mensual"];											$index_mes = $row["mes"] - 1;										?>										<tr>											<td>												<?php echo $meses[$index_mes];?>											</td>											<td>												<?php echo number_format($importe_total, 2) ;?>											</td>										</tr>										<?php										}									?>									<tr>											<th>Total Anual </th>										<th><?php echo number_format(array_sum($suma_importes), 2);?></th>									</tr>								</tbody>									</table>						</div>						<div class="col-sm-5 col-xs-7 text-center">							<canvas id="grafica">							</canvas>						</div>					</div>				</section>				<hr>				<section>					<div class="row">						<div class="col-sm-12">							<div class="row">								<div class="col-sm-6">									<h4 class="etiqueta"> Reporte de Cobranza por Cobrador Año: <?php echo $year;  ?>  </h4>								</div>								<div class="col-sm-6 text-right hidden-print">									<button type="button" class="btn btn-primary" onclick="javascript:window.print();">										<i class="fa fa-print"> </i> Imprimir									</button>									<button type="button" class="btn btn-success btn_exportar" >										<i class="fa fa-arrow-right"> </i> Exportar									</button>								</div>							</div>																												<table border="1" class="tabla_reporte" class="">								<thead>									<th>Vendedor</th>									<?php 										foreach($meses AS $index_mes => $mes){?>										<th><?php echo $mes?></th>										<?php 										}									?>									<th>Total Mensual</th>								</thead>								<tbody>									<?php										$q_cobradores = "SELECT DISTINCT(cobrador) as cobrador FROM abonos WHERE YEAR(fecha_hora_abono) = '$year'";										$result_cobradores=mysql_query($q_cobradores,$link) or die("Error en: $q_cobradores  ".mysql_error());																				$suma_mensual = array();										$suma_anual = array();										while($row = mysql_fetch_assoc($result_cobradores)){																						$suma_vendedor = array();																						$cobrador = $row["cobrador"];											$q_ventas = "SELECT											*											FROM ";											foreach($meses as $index => $mes ){												$num_mes = $index + 1;												$q_ventas.= "(												SELECT												SUM(abono) AS $mes												FROM												abonos												WHERE												YEAR (fecha_hora_abono) = '$year'												AND MONTH (fecha_hora_abono) = ".$num_mes." 												AND cobrador = '$cobrador'												AND tipo_abono  = 'Abono'												) AS $mes,";											}											$q_ventas = trim($q_ventas, ",");																																												$result_ventas=mysql_query($q_ventas,$link) or die("Error en: **$q_ventas***  ".mysql_error());																																	while($row = mysql_fetch_assoc($result_ventas)){																																			?>																						<tr>												<td><?php echo $cobrador;?></td>												<?php 													foreach($meses AS $index_mes => $mes){?>													<td class="text-right"><?php echo  number_format($row[$mes], 2);?></td>													<?php 														$suma_vendedor[] = $row[$mes];														$suma_mensual[$index_mes][] = $row[$mes];														$suma_anual[] = $row[$mes];													}												?>												<td class="text-right"><?php echo number_format(array_sum($suma_vendedor), 2) ;?></td>											</tr>											<?php											}										}									?>									<tr>											<th>Total General </th>										<?php 											foreach($meses AS $index_mes => $mes){?>											<td class="text-right">												<b><?php echo  number_format(array_sum($suma_mensual[$index_mes]), 2);?></b>											</td>											<?php 											}										?>										<td class="text-right"><b><?php echo number_format(array_sum($suma_anual), 2);?></b></td>									</tr>								</tbody>									</table>						</div>					</div>				</section>				<?php				}			?>					</div>				<?php include("scripts.php");?>				<script src="js/chart.min.js"></script>		<script>			$( document ).ready(function() {				$(".btn_exportar").click(function(){										$(this).closest("section").find("table").tableExport(					{						type:'excel',						tableName:'Registros',						escape:'false'					});				});												var labels = [];				var data = Array();								$(".tabla_grafica").find("tbody").find("tr").each(function(index, element){					labels.push($(element).find("td").first().html());					data.push(parseFloat($.trim($(element).find("td").last().html()).replace(/,/g,'')));				});																				var chart_data = {					"labels": labels, //["Red", "Blue", "Yellow", "Green", "Purple", "Orange"],					"datasets": [{            "label": 'Acumulado de Cobranza',            "data": data, //[12, 19, 3, 5, 2, 3],            "borderWidth": 1					}]				};				canvas = $("#grafica");								var chart = new Chart(canvas, {					"type": 'bar',					"data": chart_data,					options: {						animation: false,						//categoryPercentage: 1,						scales: {							yAxes: [{								ticks: {									beginAtZero:true								}							}],							xAxes: [{								"stacked": true,								//"barThickness": 30,								ticks: {									autoSkip: false,									maxRotation: 90,									minRotation: 90								}							}]						}					}				});							}); 		</script>	</body></html>	