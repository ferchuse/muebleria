<?php	include ("conex.php");	$link = Conectarse();	$response = array();	//Genera Folio de Venta, #Consecutivo-Ruta-Fecha	//$cobranza = $_POST["cobranza"];		//print_r($_POST);		if(isset( $_POST["folios"])){		$folios = $_POST["folios"];		}else{		$folios = array();	}	if(isset( $_POST["tipo_abono"])){		$tipo_abono = $_POST["tipo_abono"];		}else{		$tipo_abono = 'Abono';	}	$contador= 0;	$fecha_hora_abono = $_POST["fecha_hora_abono"];	$tarjeta = $_POST["tarjeta"];	$saldo_anterior = $_POST["saldo_anterior"];	$abono = $_POST["abono"];	$saldo_restante = $_POST["saldo_restante"];	$cobrador = $_POST["cobrador"];	$response["abonos_porcargar"] = count($tarjeta);	foreach($tarjeta as $key => $value){				//$folios[] = $contador;				if($value){			$insert_abonos ="INSERT IGNORE INTO abonos			SET 			fecha_hora_abono = STR_TO_DATE('$fecha_hora_abono[$key]', ' %d/%m/%Y %H:%i:%S' ),  			folio = '$folios[$key]', 			tarjeta = '$value', 			saldo_anterior = '$saldo_anterior[$key]', 			abono = '$abono[$key]', 			saldo_restante = '$saldo_restante[$key]',							cobrador = '$cobrador[$key]',							tipo_abono = '$tipo_abono',							hora_sync = (NOW() + INTERVAL 1 HOUR)						";			//echo $insert_venta ;					$result_abonos = mysql_query($insert_abonos);						if($result_abonos){								$response["status_abonos"] = "success" ;			}			else{				$response["status_abonos"] = "error" ;							}						//Busca el total abonado para actualizar la venta como pagada			$q_saldo_actual = "SELECT 			id_ventas, 			tarjeta,			importe, 			saldo_actual,			total_abonado,			id_estatus									FROM ventas 			LEFT JOIN 			(			SELECT			tarjeta,			IF(ISNULL(SUM(abono)), 0 ,SUM(abono))   AS total_abonado			FROM			abonos			WHERE			tarjeta = '$value'						) as t_abonado			USING (tarjeta)						WHERE tarjeta = '$value'						AND estatus_pago = 'PENDIENTE'			";						$result_saldo_actual = mysql_query($q_saldo_actual);						while($fila = mysql_fetch_array($result_saldo_actual )){								//Actualiza la venta como pagada  si el total es mayor o igual al importe de la venta				if($fila["total_abonado"] >= $fila["importe"] ){					$update_estatus = "UPDATE ventas SET estatus_pago = 'PAGADA' WHERE id_ventas = '{$fila["id_ventas"]}'";					// $result_estatus = mysql_query($update_estatus) ;				}												$saldo_actual = $fila["saldo_actual"];								//SI la tarjeta es por entregar a cliente se pasa a Tarjeta Nueva				if($fila["id_estatus"] == "13"){										$id_estatus = "20";				}				else{					$id_estatus = $fila["id_estatus"];				}				//$response["row"] = $fila;				$response["id_estatus"] = $id_estatus;								//Actualiza saldo anterior				$update_saldos = "				UPDATE ventas SET 				saldo_actual = '$saldo_restante[$key]', 				id_estatus = '$id_estatus', 				fecha_ultimo_abono = date(STR_TO_DATE( '$fecha_hora_abono[$key]', '%d/%m/%Y %H:%i:%S')) 				WHERE tarjeta = '$value'";								//$response["update"] =  $update_saldos;				$result_saldos = mysql_query($update_saldos) ;								if($update_saldos){										//$response["status_saldos"] = "success" ;				}				else{					//$response["status_saldos"] = "error" ;									}											}												if($saldo_restante[$key] <= '0'){				$update_status = "				UPDATE ventas SET 				id_estatus = '9'				WHERE tarjeta = '$value'";								$result_status = mysql_query($update_status) ;							}						//cuenta nuevas al haber cambios poner estatus tarjetas nuevas Tarjetas Nuevas						$contador++;		}	} 			$response["num_abonos"] = $contador;	echo json_encode($response);	//print_r ($fecha_hora_abono);	?>